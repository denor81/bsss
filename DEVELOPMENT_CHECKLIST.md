# Чеклист разработки проекта BSSS

## Этап 1: Подготовка окружения и базовая структура

### 1.1. Создание структуры директорий
- [ ] Создать корневую директорию проекта
- [ ] Создать директорию `modules/`
- [ ] Создать директорию `modules/helpers/`
- [ ] Создать директорию `tests/`
- [ ] Создать директорию `tests/mock-environments/`

### 1.2. Создание базовых файлов
- [ ] Создать файл `.gitignore`
- [ ] Создать файл `README.md`
- [ ] Создать файл `launcher.sh`
- [ ] Создать файл `bsss-main.sh`

## Этап 2: Разработка вспомогательных модулей (helpers)

### 2.1. Модуль `modules/helpers/common.sh`
- [ ] Реализовать функцию `check_root_permissions()`
- [ ] Реализовать функцию `check_systemd()`
- [ ] Реализовать функцию `check_write_permission()`
- [ ] Добавить заголовок функции с документацией
- [ ] Добавить обработку ошибок

### 2.2. Модуль `modules/helpers/config.sh`
- [ ] Реализовать функцию `find_last_active_parameter()`
- [ ] Реализовать функцию `generate_config_index()` с ограничением 99
- [ ] Реализовать функцию `remove_bsss_files()`
- [ ] Добавить заголовки функций с документацией
- [ ] Добавить обработку ошибок

### 2.3. Модуль `modules/helpers/input.sh`
- [ ] Реализовать функцию `confirm_yes_no()` с Y по умолчанию
- [ ] Реализовать функцию `input_ssh_port()` с валидацией 1-65535
- [ ] Добавить сжигание пробелов в input_ssh_port
- [ ] Добавить заголовки функций с документацией
- [ ] Добавить обработку ошибок

### 2.4. Модуль `modules/helpers/logging.sh`
- [ ] Реализовать функцию `init_logging()`
- [ ] Реализовать функцию `log_step()`
- [ ] Реализовать функцию `log_verbose()`
- [ ] Реализовать функцию `log_state_change()`
- [ ] Добавить заголовки функций с документацией

## Этап 3: Разработка загрузчика (launcher.sh)

### 3.1. Базовая структура
- [ ] Добавить shebang `#!/usr/bin/env bash`
- [ ] Добавить строгие режимы `set -o errexit, nounset, pipefail`
- [ ] Добавить константы `CACHE_BASE`, `REMOTE_BASE`, `SCRIPT_VERSION`

### 3.2. Функции загрузки
- [ ] Реализовать функцию `download_if_missing()`
- [ ] Реализовать функцию `load_dependencies()`
- [ ] Добавить проверку успешности загрузки
- [ ] Добавить обработку ошибок сети

### 3.3. Основная логика
- [ ] Реализовать функцию `main()`
- [ ] Добавить подключение вспомогательных модулей
- [ ] Добавить запуск основного скрипта с передачей аргументов
- [ ] Добавить вызов `main "$@"`

### 3.4. Тестирование загрузчика
- [ ] Создать тестовый сценарий загрузки из кеша
- [ ] Создать тестовый сценарий загрузки с сервера
- [ ] Проверить обработку ошибок сети

## Этап 4: Разработка основного скрипта (bsss-main.sh)

### 4.1. Базовая структура
- [ ] Добавить shebang и строгие режимы
- [ ] Добавить глобальные переменные `SSH_PORT`, `CHECK_MODE`, `DEFAULT_MODE`, `VERBOSE_MODE`
- [ ] Добавить подключение модулей

### 4.2. Обработка аргументов
- [ ] Реализовать функцию `parse_arguments()`
- [ ] Добавить обработку флага `--check`
- [ ] Добавить обработку флага `--default`
- [ ] Добавить обработку флага `-v` и `--verbose`
- [ ] Добавить обработку неизвестных параметров

### 4.3. Универсальная функция выполнения
- [ ] Реализовать функцию `execute_step()`
- [ ] Добавить логирование шага
- [ ] Добавить обработку режимов check/default/normal
- [ ] Добавить передачу аргументов в модули

### 4.4. Основная логика
- [ ] Реализовать функцию `main()`
- [ ] Добавить проверку прав root
- [ ] Добавить последовательный вызов шагов
- [ ] Добавить вызов `main "$@"`

## Этап 5: Разработка модуля system-check.sh

### 5.1. Базовая структура
- [ ] Добавить shebang и строгие режимы
- [ ] Добавить подключение helpers

### 5.2. Основная функция
- [ ] Реализовать функцию `check_reboot_required()`
- [ ] Добавить проверку файла `/var/run/reboot-required`
- [ ] Добавить вывод сообщения и выход при наличии файла
- [ ] Добавить заголовок функции с документацией

### 5.3. Интеграция
- [ ] Реализовать функцию `system_check()` с поддержкой режимов
- [ ] Добавить вызов в `bsss-main.sh`

## Этап 6: Разработка модуля system-update.sh

### 6.1. Базовая структура
- [ ] Добавить shebang и строгие режимы
- [ ] Добавить подключение helpers

### 6.2. Основная функция
- [ ] Реализовать функцию `update_system()`
- [ ] Добавить выполнение `apt update && apt upgrade -y`
- [ ] Добавить проверку успешности выполнения
- [ ] Добавить заголовок функции с документацией

### 6.3. Интеграция
- [ ] Реализовать функцию `system_update()` с поддержкой режимов
- [ ] Добавить вызов в `bsss-main.sh`

## Этап 7: Разработка модуля ssh-port.sh

### 7.1. Базовая структура
- [ ] Добавить shebang и строгие режимы
- [ ] Добавить подключение helpers
- [ ] Добавить константы `SSH_PORT_DEFAULT`, `SSH_CONFIG_DIR`, `SSH_MAIN_CONFIG`

### 7.2. Проверка состояния
- [ ] Реализовать функцию `check_ssh_port()`
- [ ] Добавить поиск в основном файле `sshd_config`
- [ ] Добавить поиск в файлах `sshd_config.d/*.conf`
- [ ] Добавить сортировку файлов по алфавиту
- [ ] Добавить возврат формата "порт:файл" или "notfound"

### 7.3. Создание конфигурации
- [ ] Реализовать функцию `create_ssh_port_config()`
- [ ] Добавить генерацию индекса файла
- [ ] Добавить создание файла с правилом Port
- [ ] Добавить проверку прав на запись

### 7.4. Применение настроек
- [ ] Реализовать функцию `apply_ssh_port_settings()`
- [ ] Добавить выполнение `systemctl daemon-reload`
- [ ] Добавить выполнение `systemctl restart ssh`
- [ ] Добавить проверку успешности перезапуска

### 7.5. Возврат к настройкам по умолчанию
- [ ] Реализовать функцию `restore_ssh_port_default()`
- [ ] Добавить поиск и удаление файлов bsss для SSH порта
- [ ] Добавить применение настроек

### 7.6. Основная функция
- [ ] Реализовать функцию `ssh_port()` с поддержкой режимов
- [ ] Добавить обработку режима `--check`
- [ ] Добавить обработку режима `--default`
- [ ] Добавить обработку нормального режима с вводом пользователя
- [ ] Добавить сохранение SSH_PORT в глобальную переменную

### 7.7. Интеграция
- [ ] Добавить вызов в `bsss-main.sh`

## Этап 8: Разработка модуля ipv6-disable.sh

### 8.1. Базовая структура
- [ ] Добавить shebang и строгие режимы
- [ ] Добавить подключение helpers
- [ ] Добавить константы для GRUB

### 8.2. Проверка состояния
- [ ] Реализовать функцию `check_ipv6_state()`
- [ ] Добавить поиск в основном файле `grub`
- [ ] Добавить поиск в файлах `grub.d/*.conf`
- [ ] Добавить обработку разных форматов `ipv6.disable=0/1`
- [ ] Добавить возврат формата "состояние:файл" или "notfound"

### 8.3. Создание конфигурации
- [ ] Реализовать функцию `create_ipv6_config()`
- [ ] Добавить генерацию индекса файла
- [ ] Добавить создание файла с правилом `ipv6.disable=1`
- [ ] Добавить проверку прав на запись

### 8.4. Применение настроек
- [ ] Реализовать функцию `apply_ipv6_settings()`
- [ ] Добавить выполнение `update-grub`
- [ ] Добавить проверку успешности выполнения

### 8.5. Возврат к настройкам по умолчанию
- [ ] Реализовать функцию `restore_ipv6_default()`
- [ ] Добавить поиск и удаление файлов bsss для IPv6
- [ ] Добавить применение настроек

### 8.6. Основная функция
- [ ] Реализовать функцию `ipv6_disable()` с поддержкой режимов
- [ ] Добавить обработку всех режимов

### 8.7. Интеграция
- [ ] Добавить вызов в `bsss-main.sh`

## Этап 9: Разработка модуля ssh-auth.sh

### 9.1. Базовая структура
- [ ] Добавить shebang и строгие режимы
- [ ] Добавить подключение helpers
- [ ] Добавить константы для SSH конфигурации

### 9.2. Проверка состояния
- [ ] Реализовать функцию `check_password_auth()`
- [ ] Добавить поиск параметра `PasswordAuthentication`
- [ ] Добавить обработку значений `yes/no`
- [ ] Добавить возврат формата "состояние:файл" или "notfound"

### 9.3. Создание конфигурации
- [ ] Реализовать функцию `create_ssh_auth_config()`
- [ ] Добавить генерацию индекса файла
- [ ] Добавить создание файла с правилом `PasswordAuthentication no`
- [ ] Добавить проверку прав на запись

### 9.4. Применение настроек
- [ ] Реализовать функцию `apply_ssh_auth_settings()`
- [ ] Добавить выполнение `systemctl restart ssh`
- [ ] Добавить проверку успешности перезапуска

### 9.5. Возврат к настройкам по умолчанию
- [ ] Реализовать функцию `restore_ssh_auth_default()`
- [ ] Добавить поиск и удаление файлов bsss для SSH авторизации
- [ ] Добавить применение настроек

### 9.6. Основная функция
- [ ] Реализовать функцию `ssh_auth()` с поддержкой режимов
- [ ] Добавить обработку всех режимов

### 9.7. Интеграция
- [ ] Добавить вызов в `bsss-main.sh`

## Этап 10: Разработка модуля ufw-setup.sh

### 10.1. Базовая структура
- [ ] Добавить shebang и строгие режимы
- [ ] Добавить подключение helpers

### 10.2. Получение SSH порта
- [ ] Реализовать функцию `get_current_ssh_port()`
- [ ] Добавить вызов `ssh_port --check` для получения порта
- [ ] Добавить обработку результата
- [ ] Добавить использование глобальной переменной SSH_PORT

### 10.3. Настройка UFW
- [ ] Реализовать функцию `setup_ufw()`
- [ ] Добавить разрешение SSH порта
- [ ] Добавить установку политики deny incoming
- [ ] Добавить активацию UFW
- [ ] Добавить проверку успешности выполнения

### 10.4. Отключение UFW
- [ ] Реализовать функцию `disable_ufw()`
- [ ] Добавить отключение UFW с сбросом правил
- [ ] Добавить проверку успешности выполнения

### 10.5. Основная функция
- [ ] Реализовать функцию `ufw_setup()` с поддержкой режимов
- [ ] Добавить обработку режима `--check`
- [ ] Добавить обработку режима `--default`
- [ ] Добавить обработку нормального режима с подтверждением

### 10.6. Интеграция
- [ ] Добавить вызов в `bsss-main.sh`

## Этап 11: Разработка тестового окружения

### 11.1. Создание mock окружений
- [ ] Создать `tests/mock-environments/scenario-1/` (базовый)
- [ ] Создать `tests/mock-environments/scenario-2/` (с .d директориями)
- [ ] Создать `tests/mock-environments/scenario-3/` (с правилами в .d)
- [ ] Создать `tests/mock-environments/scenario-4/` (конфликтующие правила)
- [ ] Наполнить каждый сценарий соответствующими файлами конфигурации

### 11.2. Разработка test-runner.sh
- [ ] Создать файл `tests/test-runner.sh`
- [ ] Реализовать функцию `setup_test_environment()`
- [ ] Реализовать функцию `run_scenario_tests()`
- [ ] Реализовать функцию `cleanup_test_environment()`
- [ ] Реализовать функцию `run_all_tests()`

### 11.3. Тестирование модулей
- [ ] Создать тесты для каждого модуля в каждом сценарии
- [ ] Проверить режим `--check` для всех модулей
- [ ] Проверить режим `--default` для всех модулей
- [ ] Проверить нормальный режим для всех модулей

### 11.4. Тестирование загрузчика
- [ ] Создать тест загрузки из кеша
- [ ] Создать тест загрузки с сервера
- [ ] Проверить обработку ошибок сети

## Этап 12: Интеграционное тестирование

### 12.1. Полное тестирование скрипта
- [ ] Протестировать полный запуск в нормальном режиме
- [ ] Протестировать полный запуск в режиме `--check`
- [ ] Протестировать полный запуск в режиме `--default`
- [ ] Протестировать запуск с флагом `-v`

### 12.2. Тестирование крайних случаев
- [ ] Протестировать с отсутствующими директориями .d
- [ ] Протестировать с отсутствующими правами на запись
- [ ] Протестировать с некорректными конфигурационными файлами
- [ ] Протестировать с максимальными индексами файлов (99)

### 12.3. Тестирование взаимодействия
- [ ] Протестировать передачу SSH порта в UFW модуль
- [ ] Протестировать последовательное применение правил
- [ ] Протестировать откат изменений

## Этап 13: Финализация и документация

### 13.1. Обновление документации
- [ ] Обновить `README.md` с инструкциями по использованию
- [ ] Добавить примеры запуска
- [ ] Добавить описание всех флагов
- [ ] Добавить troubleshooting секцию

### 13.2. Проверка качества кода
- [ ] Проверить соответствие лучшим практикам Shell
- [ ] Проверить наличие заголовков функций
- [ ] Проверить обработку ошибок
- [ ] Проверить использование двойных кавычек

### 13.3. Подготовка к распространению
- [ ] Создать пример команды one-line запуска
- [ ] Подготовить репозиторий для размещения файлов
- [ ] Проверить работу загрузчика с реального репозитория
- [ ] Создать релиз с версией 1.0.0

## Этап 14: Дополнительные улучшения (TODO)

### 14.1. Улучшения безопасности
- [ ] Добавить проверку свободности SSH порта
- [ ] Добавить валидацию пользовательского ввода для всех параметров
- [ ] Добавить создание резервных копий перед изменениями

### 14.2. Улучшения функциональности
- [ ] Добавить поддержку других дистрибутивов Linux
- [ ] Добавить интерактивный режим с меню выбора
- [ ] Добавить прогресс-бар для долгих операций

### 14.3. Улучшения тестирования
- [ ] Добавить автоматические тесты CI/CD
- [ ] Добавить тесты производительности
- [ ] Добавить тесты на различных версиях Ubuntu