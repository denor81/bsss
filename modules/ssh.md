## 🔧 **Логическая карта с вашими уточнениями:**

```
┌─────────────────────────────────────────────┐
│          Упрощенная SSH Port Update         │
├─────────────────────────────────────────────┤
│                   START                     │
├─────────────────────────────────────────────┤
│           1. Базовые проверки               │
│  • Проверка Include в sshd_config          │
│    (если нет → добавляем)                   │
├─────────────────────────────────────────────┤
│          2. Валидация порта                 │
│  • Число ли? 1-65535                        │
│  • Если < 1024 → warning (но разрешаем)     │
│  • Проверка занятости порта                 │
│    (if ss -tlnp | grep -q ":$PORT"; then)    │
│    ┌──────────────────────────────────────┐ │
│    │        Порт свободен?                │ │
│    └──────────────────────────────────────┘ │
│               ↓             ↓               │
│              Да             Нет             │
│               ↓             ↓               │
│    Продолжаем         Показываем           │
│                       процесс-заниматель    │
│                       → Выход с ошибкой     │
├─────────────────────────────────────────────┤
│        3. Управление файлом                 │
│  • Ищем ВСЕ файлы по маске bsss-ssh-port.conf│
│    (независимо от префикса 10- 20- и т.д.)  │
│    ┌──────────────────────────────────────┐ │
│    │   Найден файл от нашего скрипта?     │ │
│    └──────────────────────────────────────┘ │
│               ↓             ↓               │
│      Да (обновление)      Нет (создание)   │
│               ↓             ↓               │
│    • Удаляем найденные   • Создаем новый   │
│      файл   ы               файл с именем:  │
│                              10-bsss-ssh-port│
│                            .conf            │
│               ↓                             │
│    ┌──────────────────────────────────────┐ │
│    │     Создаем/обновляем файл           │ │
│    └──────────────────────────────────────┘ │
│    • Комментарий: Generated by bsss        │
│    • Директива: Port <номер_порта>         │
│    • Только одна строка!                   │
├─────────────────────────────────────────────┤
│          4. Рестарт сервиса                 │
│  • systemctl daemon-reload затем systemctl restart ssh│
│  • (без проверки успешности... пока без проверки)│
├─────────────────────────────────────────────┤
              │
└─────────────────────────────────────────────┘
```

## 📁 **Специфика файловой логики:**

```
Директория: /etc/ssh/sshd_config.d/

Наша маска: bsss-ssh-port.conf (10-bsss-ssh-port.conf, 20-bsss-ssh-port.conf... неважно - важно - bsss-ssh-port.conf это наша маска для этого модуля - по ней мы определяем есть ли наша настройка в системе или нет)

Логика поиска:
find /etc/ssh/sshd_config.d -type f -iname "*bsss-ssh-port.conf"

Правило: УДАЛЯЕМ ВСЕ найденные файлы с "bsss-ssh-port.conf" в имени
Затем: СОЗДАЕМ новый файл с именем 10-bsss-ssh-port.conf
```

## 🔄 **Особенности работы с портами:**

```
SSH может слушать на нескольких портах:
Port 22
Port 2222
Port 3333  ← наш новый порт

Наша стратегия:
1. Мы НЕ трогаем существующие Port директивы и не трогаем файлы не по нашей маске
2. Мы ДОБАВЛЯЕМ наш порт в список
3. SSH будет слушать на ВСЕХ портах из ВСЕХ конфигов

Пример итоговой конфигурации:
/etc/ssh/sshd_config.d/10-bsss-ssh-port.conf     → Port 3333 ← наш

Итог: SSH слушает на 22, 2222, 3333
```

## ⚠️ **Критические упрощения (осознанные):**

```
1. НЕТ проверки синтаксиса конфига
   - Мы создаем только валидный Port <number>
   - В шапке файла комментарий - Создан BSSS

2. НЕТ проверки успешности рестарта (пока нет)
   - Предполагаем, что systemctl restart всегда работает
   - В худшем случае: SSH не перезапустится, но старый порт останется

3. НЕТ сложного отката

4. НЕТ работы с firewall/SELinux (пока нет)
   - Пользователь должен настроить самостоятельно
   - Или будем добавлять позже

5. НЕТ сохранения старого порта
   - Удаляем файл → теряем информацию о предыдущем нашем порте
   - Но это не страшно, так как можно задать заново
```

## 🎯 **Ультра-упрощенный алгоритм:**

```
Шаг 1: Проверить что порт валиден и свободен
Шаг 2: Найти и удалить ВСЕ старые *bsss-ssh-port.conf
Шаг 3: Создать новый файл с Port <номер>
Шаг 4: Перезапустить SSH
Шаг 5: Готово (без проверок)
```

## 💡 **Что дает такая простота:**

1. **Минимум кода** - меньше багов
2. **Предсказуемость** - всегда одинаковое поведение  
3. **Легкая отладка** - понятно что происходит
4. **Быстрая разработка** - можно сразу использовать
5. **Легко расширять** - потом добавим проверки

## ✅ **Итоговая оценка логики:**

**Работоспособность:** ✅ Да, логика работоспособна  
**Безопасность:** ⚠️ Средняя (нет проверок рестарта)  
**Надежность:** ⚠️ Средняя (простые edge cases не обрабатываются)  
**Простота:** ✅ Высокая (легко понять и поддерживать)  

**Рекомендация:** Логика подходит для внутренних/контролируемых сред. Для production добавить хотя бы проверку активности SSH после рестарта.