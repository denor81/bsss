# Анализ рефакторинга и правила написания модулей

## Сравнительный анализ версий файла modules/01-check-os.sh

### Предыдущая версия (до рефакторинга)
```bash
check() {
    local status
    local message
    local symbol

    # shellcheck disable=SC1090
    if source "$OS_RELEASE_FILE" 2>/dev/null; then

        if [[ "$ID" != "$ALLOWED_SYS" ]]; then
            status=1
            message="$ID не поддерживается, поддерживается только ${ALLOWED_SYS^}"
            symbol="$SYMBOL_ERROR"
        else
            status=0
            message="Текущая система ${ID^} $VERSION_ID поддерживается"
            symbol="$SYMBOL_SUCCESS"
        fi

    fi
    
    # Вывод в Key-Value формате для парсинга через eval
    echo "message=\"$(printf '%s' "$message" | base64)\""
    echo "symbol=\"$(printf '%s' "$symbol" | base64)\""
    
    # Возвращаем код в зависимости от статуса
    return $status
}
```

### Текущая версия (после рефакторинга)
```bash
check() {
    local os_release_file=${1:-$OS_RELEASE_FILE}
    local allowed_sys=${2:-$ALLOWED_SYS}
    local status
    local message
    local symbol

    # shellcheck disable=SC1090
    if [[ -f "$os_release_file" ]]; then
        source "$os_release_file"

        if [[ "$ID" != "$allowed_sys" ]]; then
            status=1
            message="$ID не поддерживается, поддерживается только ${allowed_sys^}"
            symbol="$SYMBOL_ERROR"
        else
            status=0
            message="Текущая система ${ID^} $VERSION_ID поддерживается"
            symbol="$SYMBOL_SUCCESS"
        fi
    else
        status=1
        message="Файл $os_release_file не наден"
        symbol="$SYMBOL_ERROR"
    fi
    
    # Вывод в Key-Value формате для парсинга через eval
    echo "message=\"$(printf '%s' "$message" | base64)\""
    echo "symbol=\"$(printf '%s' "$symbol" | base64)\""
    echo "status=$status"
}
```

## Ключевые изменения и их обоснование

### 1. Добавление параметров в функцию
- **Изменение**: Добавлены параметры `os_release_file` и `allowed_sys` со значениями по умолчанию
- **Преимущество**: Повышает гибкость функции, позволяя тестировать её с разными файлами и системами
- **Принцип**: Соответствует лучшим практикам проектирования функций с параметрами

### 2. Явная проверка существования файла
- **Изменение**: Добавлена проверка `[[ -f "$os_release_file" ]]` перед sourcing
- **Преимущество**: Четкая обработка случая отсутствия файла
- **Принцип**: Защитное программирование - проверка предварительных условий

### 3. Изменение способа возврата статуса
- **Изменение**: Статус выводится через `echo "status=$status"` вместо `return $status`
- **Преимущество**: Унифицированный способ передачи данных в родительский модуль
- **Принцип**: Консистентный интерфейс между модулями

### 4. Улучшение обработки ошибок
- **Изменение**: Добавлена явная обработка случая отсутствия файла с сообщением об ошибке
- **Преимущество**: Предоставляет пользователю понятную информацию о проблеме
- **Принцип**: Грациозная деградация с информативными сообщениями

## Правила написания модулей

### 1. Принцип минимальной функциональности
- **Правило**: Каждый модуль должен реализовывать только минимально необходимый функционал
- **Обоснование**: Упрощает понимание, тестирование и поддержку кода
- **Пример**: Модуль проверки ОС только проверяет ОС, не пытается её исправить

### 2. Соответствие правилам проекта
- **Правило**: Следование стилю и паттернам, определенным в BEST_PRACTIES/SHELL.md
- **Обоснование**: Обеспечивает консистентность кода во всем проекте
- **Пример**: Использование `set -Eeuo pipefail`, правильный нейминг, форматирование

### 3. Минимальная когнитивная сложность
- **Правило**: Код должен быть понятен даже новичку
- **Обоснование**: Упрощает онбординг новых разработчиков и снижает вероятность ошибок
- **Пример**: Простая структура условий, отсутствие сложных вложенных конструкций

### 4. Стандартизированный возврат статуса
- **Правило**: Статус невозможности продолжения выполнения передается в параметре родительскому модулю
- **Обоснование**: Централизованная обработка ошибок в основном модуле
- **Пример**: `echo "status=$status"` вместо `return $status`

### 5. Минимальная обработка ошибок
- **Правило**: Обрабатываются только ошибки, связанные с логикой скрипта
- **Обоснование**: Остальные ошибки обрабатываются общими механизмами (`set -e`)
- **Пример**: Проверка существования файла ОС, но не обработка ошибок чтения

### 6. Параметризация функций
- **Правило**: Ключевые значения передаются как параметры с разумными значениями по умолчанию
- **Обоснование**: Упрощает тестирование и переиспользование кода
- **Пример**: `local os_release_file=${1:-$OS_RELEASE_FILE}`

### 7. Унифицированный формат вывода
- **Правило**: Все функции возвращают данные в унифицированном формате для парсинга
- **Обоснование**: Обеспечивает консистентную обработку результатов
- **Пример**: Key-Value формат с base64 кодированием для текстовых данных

### 8. Документирование через код
- **Правило**: Имена функций и переменных должны быть самодокументирующимися
- **Обоснование**: Снижает необходимость в избыточных комментариях
- **Пример**: `check_os_compatibility` вместо `check`

### 9. Консистентная структура модулей
- **Правило**: Все модули следуют единой структуре
- **Обоснование**: Упрощает навигацию по коду
- **Пример**: 
  1. Константы в начале файла
  2. Подключение библиотек
  3. Основная функция
  4. Функция main
  5. Guard clause

### 10. Тестируемость
- **Правило**: Код должен быть легко тестируемым
- **Обоснование**: Обеспечивает надежность и предотвращает регрессии
- **Пример**: Параметризация функции позволяет подставлять тестовые данные

## Принципы для первых двух модулей

### Модуль 1: Проверка операционной системы
- **Задача**: Проверить, что система соответствует требованиям
- **Особенности**: Только проверка, никаких изменений в системе
- **Возврат**: Статус соответствия системы требованиям

### Модуль 2: Проверка прав пользователя
- **Задача**: Проверить, что у пользователя есть права root или он в группе sudo
- **Особенности**: Только проверка, никаких попыток повышения привилегий
- **Возврат**: Статус наличия необходимых прав

## Заключение

Рефакторинг файла `modules/01-check-os.sh` продемонстрировал переход от более сложной реализации к более простой и понятной, соответствующей принципам минимальной функциональности и низкой когнитивной сложности. Ключевые изменения направлены на повышение гибкости, тестируемости и консистентности кода при сохранении его простоты.