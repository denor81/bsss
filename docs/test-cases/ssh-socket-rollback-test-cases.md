# SSH Socket Rollback Test Cases

## Сценарий 1: Успешное переключение с подтверждением

### Описание
Пользователь соглашается переключить SSH на service режим, подключение успешно, пользователь подтверждает. Система фиксирует изменения.

### Шаги выполнения
1. Запустить модуль проверки: `bash /home/ubuntu/bsss/modules/03-ssh-socket-check.sh`
2. Подтвердить переключение на service режим
3. Открыть новый терминал
4. Подключиться к серверу по SSH
5. В исходном терминале подтвердить успешное подключение

### Ожидаемый результат
- Watchdog остановлен
- SSH работает в service режиме
- FIFO канал удален
- Сообщение "Изменения зафиксированы, Rollback отключен"

### Команды проверки
```bash
# Проверка режима
systemctl status ssh.socket | grep "inactive"
systemctl status ssh.service | grep "active (running)"

# Проверка отсутствия FIFO
ls /home/ubuntu/bsss/bsss_watchdog_*.fifo 2>&1 | grep "No such file or directory"
```

## Сценарий 2: Автоматический откат по таймауту (10 сек)

### Описание
Пользователь переключает SSH на service режим, но не подтверждает подключение. По истечении 10 секунд происходит автоматический откат на socket режим.

### Шаги выполнения
1. Запустить модуль проверки: `bash /home/ubuntu/bsss/modules/03-ssh-socket-check.sh`
2. Подтвердить переключение на service режим
3. Не открывать новый терминал, не проверять подключение
4. Дождаться истечения таймаута (10 секунд)

### Ожидаемый результат
- Watchdog выполняет откат
- SSH возвращен в socket режим
- Основной скрипт завершается с кодом 3
- FIFO канал удален

### Команды проверки
```bash
# Проверка режима (должен быть socket)
systemctl status ssh.socket | grep "active (listening)"
systemctl status ssh.service | grep "inactive"

# Проверка отсутствия FIFO
ls /home/ubuntu/bsss/bsss_watchdog_*.fifo 2>&1 | grep "No such file or directory"
```

## Сценарий 3: Немедленный откат при неудачном запуске service

### Описание
При переключении на service режим сервис не запускается. Система немедленно выполняет откат на socket режим.

### Шаги выполнения
1. Временно сделать ssh.service нерабочим (например, закомментировать ExecStart)
2. Запустить модуль проверки: `bash /home/ubuntu/bsss/modules/03-ssh-socket-check.sh`
3. Подтвердить переключение на service режим
4. Наблюдать за сообщениями об ошибке и отката

### Ожидаемый результат
- Сообщение "SSH service не запустился"
- Автоматический откат на socket режим
- Скрипт зависает в `while true; do sleep 1; done` (ожидание таймаута watchdog)
- Watchdog завершает откат

### Команды проверки
```bash
# Проверка режима (должен быть socket)
systemctl status ssh.socket | grep "active (listening)"
systemctl status ssh.service | grep "inactive"
```

## Сценарий 4: Отказ пользователя от переключения

### Описание
Пользователь отказывается переключать SSH на service режим. Изменения не вносятся.

### Шаги выполнения
1. Запустить модуль проверки: `bash /home/ubuntu/bsss/modules/03-ssh-socket-check.sh`
2. Отказаться от переключения на service режим

### Ожидаемый результат
- Сообщение "Отказ от переключения режима. Выполнение невозможно."
- Скрипт завершается с кодом 1
- SSH продолжает работать в socket режиме
- Watchdog не запускается
- FIFO не создается

### Команды проверки
```bash
# Проверка режима (должен остаться socket)
systemctl status ssh.socket | grep "active (listening)"
systemctl status ssh.service | grep "inactive"

# Проверка отсутствия FIFO
ls /home/ubuntu/bsss/bsss_watchdog_*.fifo 2>&1 | grep "No such file or directory"
```

## Сценарий 5: Обработка неверной конфигурации sshd

### Описание
Конфигурация sshd содержит ошибки. Система прерывает операцию до внесения изменений.

### Шаги выполнения
1. Временно добавить ошибку в sshd_config (например, недопустимую директиву)
2. Запустить модуль проверки: `bash /home/ubuntu/bsss/modules/03-ssh-socket-check.sh`
3. Подтвердить переключение на service режим

### Ожидаемый результат
- Сообщение "Конфигурация sshd содержит ошибки"
- Сообщение "Исправьте конфигурацию и запустите проверку снова"
- Скрипт завершается с кодом 1
- Изменения не вносятся
- Watchdog не запускается
- FIFO не создается

### Команды проверки
```bash
# Проверка валидации конфигурации
sshd -t  # Должен вернуть ошибку

# Проверка режима (должен остаться неизменным)
systemctl status ssh.socket  # Должен работать как был
systemctl status ssh.service  # Должен работать как был

# Проверка отсутствия FIFO
ls /home/ubuntu/bsss/bsss_watchdog_*.fifo 2>&1 | grep "No such file or directory"
```

## Дополнительные тесты

### Тест прерывания по SIGUSR1
- Запустить переключение
- Отправить SIGUSR1 процессу
- Проверить корректное завершение с кодом 3

### Тест прерывания по SIGUSR2
- Запустить переключение
- Отправить SIGUSR2 watchdog
- Проверить выполнение немедленного отката

### Тест множественных запусков
- Запустить модуль несколько раз подряд
- Проверить отсутствие конфликтов FIFO каналов
- Проверить корректную очистку временных файлов

### Тест восстановления после сбоя
- Имитировать сбой во время переключения (kill -9 основного процесса)
- Проверить, что watchdog выполняет откат
- Проверить, что система возвращается в работоспособное состояние
