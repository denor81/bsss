# I18n (Internationalization) Design Document

> **Date:** 2026-02-03
> **Status:** Design Complete
> **Goal:** Implement bilingual support (Russian/English) with extensible architecture

## Overview

A simple and effective i18n system for BSSS project using Bash 4+ associative arrays. Zero external dependencies, easy to extend for additional languages.

## Architecture Decisions

### 1. Approach: Associative Arrays + Modular Files

**Choice:** Native Bash 4+ associative arrays with per-language files

**Rationale:**
- Zero external dependencies (only Bash 4+ required, available since 2009)
- Simple file-based structure (text files, easy to edit)
- Fast O(1) lookup by key
- Extensible: add language = new folder
- Minimal code: ~50 lines of core logic

**Alternatives considered:**
- ❌ GNU gettext - requires gettext/msgfmt/xgettext tools
- ❌ sh-i18n library - external dependency, beta status
- ✅ **Selected:** Associative arrays - native, fast, no deps

### 2. File Structure

```
bsss/
├── .lang                    # Language marker: ru|en|cn|...
├── lib/
│   ├── vars.conf            # Add: I18N_DIR="lib/i18n"
│   ├── logging.sh            # Modified: log_* use _() function
│   └── i18n/
│       ├── core.sh           # _() function (translator)
│       ├── loader.sh         # i18n::init, i18n::load, i18n::detect
│       ├── ru/
│       │   ├── common.sh      # COMMON_MESSAGES associative array
│       │   ├── ssh.sh         # SSH_MESSAGES
│       │   ├── ufw.sh         # UFW_MESSAGES
│       │   └── system.sh      # SYSTEM_MESSAGES
│       └── en/
│           ├── common.sh
│           ├── ssh.sh
│           ├── ufw.sh
│           └── system.sh
└── modules/
    ├── helpers/ssh-port.sh   # log_info "ssh.ui.get_action_choice.available_actions"
    ├── helpers/ufw.sh
    └── ...
```

### 3. Key Naming Convention

**Format:** `module.submodule.action.message_type`

**Examples:**
- `common.error_root_privileges` - General error messages
- `ssh.ui.get_action_choice.available_actions` - SSH UI messages
- `ufw.rule.reset_and_pass.info_rules_deleted` - UFW success messages
- `system.update.info_packages_updating` - System info messages

**Prefixes:**
- `.error_` - Error messages
- `.info_` - Informational messages
- `.success_` - Success messages
- `.warning_` - Warning messages
- `.hint_` - Input hints
- `.default_` - Default values

### 4. Translation File Format

**Example: `lib/i18n/ru/ssh.sh`**

```bash
# SSH port messages (Russian)

# Menu UI
I18N_MESSAGES["ssh.ui.get_action_choice.available_actions"]="Доступные действия:"
I18N_MESSAGES["ssh.ui.get_action_choice.option_reset"]="Сброс (удаление правила ${UTIL_NAME^^})"
I18N_MESSAGES["ssh.ui.get_action_choice.option_reinstall"]="Переустановка (замена на новый порт)"
I18N_MESSAGES["ssh.ui.get_action_choice.option_exit"]="Выход"
I18N_MESSAGES["ssh.ui.get_action_choice.ask_select"]="Выберите действие"
I18N_MESSAGES["ssh.ui.get_action_choice.hint"]="Выберите число от 0 до 2"

# Error messages
I18N_MESSAGES["ssh.config.create_bsss_file.error"]="Не удалось создать правило SSH: %s"
I18N_MESSAGES["ssh.socket.wait_for_ssh_up.error"]="ПОРТ %s НЕ ПОДНЯЛСЯ [%s попыток в течение %s сек]"

# Info messages
I18N_MESSAGES["ssh.socket.wait_for_ssh_up.info"]="Ожидание поднятия SSH порта %s (таймаут: %s сек)..."
I18N_MESSAGES["ssh.info_rules_found"]="Есть правила ${UTIL_NAME^^} для SSH:"

# Menu items (numbers passed as arguments!)
I18N_MESSAGES["ssh.menu.item_reset"]="%s. Сброс (удаление правила %s)"
I18N_MESSAGES["ssh.menu.item_reinstall"]="%s. Переустановка (замена на новый порт)"
I18N_MESSAGES["ssh.menu.item_exit"]="%s. Выход"
```

### 5. Usage Examples

**Before migration:**
```bash
log_info "Доступные действия:"
log_info_simple_tab "1. Сброс (удаление правила ${UTIL_NAME^^})"
```

**After migration:**
```bash
log_info "ssh.ui.get_action_choice.available_actions"
log_info_simple_tab "ssh.menu.item_reset" "1" "${UTIL_NAME^^}"
# Output: 1. Сброс (удаление правила BSSS)
```

**With arguments:**
```bash
# Single argument
log_info "ssh.socket.wait_for_ssh_up.info" "$port" "$timeout"
# Output: Ожидание поднятия SSH порта 2222 (таймаут: 4 сек)...

# Multiple arguments
log_success "ssh.socket.wait_for_ssh_up.success" "$port" "$attempts" "$elapsed"
# Output: SSH порт 2222 успешно поднят после 5 попыток в течение 12 сек
```

**IMPORTANT: Dynamic data (like menu numbers) must be passed as arguments:**

❌ **WRONG (number hardcoded in translation):**
```bash
# Translation file
I18N_MESSAGES["ssh.menu.item_exit"]="0. Выход"    # ERROR!

# Code
log_info_simple_tab "ssh.menu.item_exit"
```

✅ **CORRECT (number passed as argument):**
```bash
# Translation file
I18N_MESSAGES["ssh.menu.item_exit"]="%s. Выход"

# Code
log_info_simple_tab "ssh.menu.item_exit" "0"    # Output: 0. Выход
```

**The `no_translate` placeholder:**

Used for outputting text without translation (file paths, dynamically generated strings):

```bash
# lib/i18n/ru/common.sh
I18N_MESSAGES["no_translate"]="%s"

# Output file path
log_info_simple_tab "no_translate" "/etc/ssh/sshd_config:Port 22"

# Output dynamically generated string
local menu_text="$id. $action"
log_info_simple_tab "no_translate" "$menu_text"
```

**When to use `i18n::get()` or `_()` directly:**

✅ **CORRECT usage in IO functions:**
```bash
# io::confirm_action
io::confirm_action "$(_ "key")"

# io::ask_value
io::ask_value "$(_ "key")" "$default" "$pattern" "$hint"

# printf with translation
printf "$(i18n::get "key")" "$arg1"
```

❌ **WRONG usage in loggers:**
```bash
# ERROR - double translation!
log_info "$(_ "key")"             # log_info already calls _()

# CORRECT
log_info "key"                     # log_info will translate automatically
```

**All logger functions automatically call `_()` internally:**
- `log_info`, `log_error`, `log_success`, `log_warn`, etc.
- `log_info_simple_tab`, `log_bold_info`, etc.

So you only pass the key (or `no_translate` + text) to loggers.

### 6. Migration Priority Order

1. **Priority 1:** Modules with most text (helpers/ssh-port.sh)
   - Create `lib/i18n/ru/ssh.sh` and `lib/i18n/en/ssh.sh`
   - Migrate all `log_info "text"` → `log_info "message_key"`
   - Migrate all `log_error "text"` → `log_error "message_key"`

2. **Priority 2:** Modules with moderate text (helpers/ufw.sh)
   - Create `lib/i18n/ru/ufw.sh` and `lib/i18n/en/ufw.sh`
   - Migrate text strings

3. **Priority 3:** System modules (system-update.sh, system-reload-check.sh)
   - Create system translation files
   - Migrate strings

4. **Priority 4:** Check modules (os-check.sh)
   - Create `lib/i18n/ru/os.sh` and `lib/i18n/en/os.sh`
   - Migrate minimal strings

5. **Priority 5 (Last):** Main script (main.sh)
   - Add i18n initialization at the beginning
   - After all other modules are migrated

## Components

### Component 1: Core Translation Function (`lib/i18n/core.sh`)

```bash
#!/usr/bin/env bash
#
# @type:        Source
# @description: Переводчик сообщений по ключу
# @params:      message_key - Ключ сообщения в i18n системе
#               args - Аргументы для форматирования (опционально)
# @stdin:       нет
# @stdout:      Переведенное сообщение
# @exit_code:   0 - успех, 1 - ключ не найден

declare -gA I18N_MESSAGES

_() {
    local key="$1"
    shift

    if [[ -v I18N_MESSAGES["$key"] ]]; then
        if [[ $# -gt 0 ]]; then
            printf "${I18N_MESSAGES["$key"]}" "$@"
        else
            echo "${I18N_MESSAGES["$key"]}"
        fi
    else
        echo "[$key] NOT TRANSLATED" >&2
    fi
}

# @type:        Source
# @description: Псевдоним для функции _() для использования в модулях
# @params:      message_key - Ключ сообщения в i18n системе
#               args - Аргументы для форматирования (опционально)
# @stdin:       нет
# @stdout:      Переведенное сообщение
# @exit_code:   0 - успех, 1 - ключ не найден
i18n::get() {
    _ "$@"
}
```

### Component 2: Loader (`lib/i18n/loader.sh`)

- Detects language from `.lang` file
- Loads all translation files for selected language
- Falls back to `ru` if `.lang` doesn't exist

### Component 3: Logging Integration (`lib/logging.sh`)

All logger functions automatically call `_()` internally - you don't need to call it explicitly:

- `log_info()` → `log_info "message_key" [args...]`
- `log_error()` → `log_error "message_key" [args...]`
- `log_success()` → `log_success "message_key" [args...]`
- `log_info_simple_tab()` → `log_info_simple_tab "message_key" [args...]` or `log_info_simple_tab "no_translate" "text"`

Example logger implementation:
```bash
log_info() {
    local msg_key="$1"
    local type="INFO"
    local formatted_msg
    local msg

    msg="$(_ "$msg_key" "${@:2}")"  # _() called automatically!
    formatted_msg="$(date '+%H:%M:%S') [$type] [$CURRENT_MODULE_NAME] $msg"
    echo -e "$SYMBOL_INFO [$CURRENT_MODULE_NAME] $msg" >&2
    echo "$formatted_msg" >> "$CURRENT_LOG_SYMLINK" 2>/dev/null || true
    log::to_journal "$msg" "$type"
}
```

### Component 4: Language Marker (`.lang`)

Simple text file with language code:
- Empty or missing → defaults to `ru`
- Supported: `ru`, `en`, `cn`, `es`, `fr`, `de`

## Testing Strategy

1. **Test Russian (default):**
   ```bash
   rm -f .lang
   ./main.sh
   ```

2. **Test English:**
   ```bash
   echo "en" > .lang
   ./main.sh
   ```

3. **Test Chinese (future):**
   ```bash
   mkdir -p lib/i18n/cn
   # Copy files and translate...
   echo "cn" > .lang
   ./main.sh
   ```

4. **Verify:** Check that all messages are translated, no hardcoded strings remain

## Adding New Language

1. Create directory: `lib/i18n/{LANG_CODE}/`
2. Copy translation files from `ru/` to new directory
3. Translate all values in associative arrays
4. Update `.lang` file with language code
5. Test

## Constraints

- Bash 4+ required (for associative arrays)
- Zero external dependencies
- File-based storage (text files)
- Simple syntax: `declare -gA ARRAY_NAME`
- Fallback: Russian (`ru`) if `.lang` missing

## Success Criteria

- [x] `.lang` file works for language switching
- [x] `lib/i18n/` directory structure created
- [x] `core.sh` with `_()` function working and `I18N_MESSAGES` declared
- [x] `loader.sh` detects and loads translations
- [x] `logging.sh` uses `_()` for all messages automatically
- [x] All modules migrated to use message keys
- [x] `no_translate` placeholder implemented for non-translatable text
- [x] Tested with Russian and English
- [x] Documentation updated (AGENTS.md and this document)
- [x] Dynamic data (menu numbers, etc.) properly passed as arguments, not hardcoded in translations