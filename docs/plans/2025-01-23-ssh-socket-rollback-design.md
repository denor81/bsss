# SSH Socket Rollback Design Document

## 1. Обзор проблемы и требований

### Проблема
SSH в режиме socket-активации может вызывать проблемы с поднятием портов после изменения конфигурации. Пользователям необходимо переключаться на классический режим ssh.service, но это критическая операция, требующая механизма отката в случае неудачи.

### Требования
- Безопасное переключение SSH с socket на service режим
- Автоматический откат по таймауту (10 секунд)
- Защита от потери доступа к серверу
- Подтверждение пользователем успешного подключения
- Инструкции для пользователя в процессе переключения

## 2. Архитектура решения

### Компоненты
1. **Watchdog (utils/rollback.sh)**: Фоновый процесс, отслеживающий таймаут и выполняющий откат
2. **Оркестратор (modules/03-ssh-socket-check.sh)**: Управляет процессом переключения
3. **Helper функции (modules/03-ssh-socket-helpers.sh)**: Реализуют переключение режимов
4. **FIFO коммуникация**: Синхронизация между watchdog и основным процессом

### Механизм работы
1. Создается FIFO канал для коммуникации
2. Запускается watchdog процесс ДО внесения изменений
3. Вносятся изменения (переключение на service)
4. Пользователь проверяет подключение в новом терминале
5. При успешном подключении - пользователь подтверждает, watchdog останавливается
6. При неудаче или таймауте - watchdog выполняет откат на socket режим

## 3. Поток данных и последовательность операций

### Последовательность операций
```
[START] -> Валидация sshd_config
         -> Создание FIFO
         -> Запуск watchdog (таймер 10 сек)
         -> Показ инструкций пользователю
         -> Переключение на service режим
         -> Проверка запуска service
         -> Подтверждение пользователя?
              /   \
          [YES]   [NO/TIMEOUT]
            |        |
       Stop watchdog  Rollback to socket
            |        |
         [SUCCESS]  [ROLLBACK COMPLETE]
```

### FD и потоки
- **FD 0 (stdin)**: Ввод от пользователя
- **FD 1 (stdout)**: Чистые данные для пайплайнов (не используется)
- **FD 2 (stderr)**: Логи, интерфейс, сообщения (log_info, log_error)
- **FD 3**: Временный дескриптор для watchdog (в utils/rollback.sh)

## 4. Обработка ошибок и краевые случаи

### Ошибки конфигурации
- **Невалидный sshd_config**: Прерывание до внесения изменений
- **Ошибка переключения на service**: Откат на socket

### Таймауты
- **Таймаут 10 секунд**: Автоматический откат на socket
- **Разрыв сессии**: Watchdog продолжает работать, выполняет откат

### Сигнальная обработка
- **SIGUSR1**: Остановка основного скрипта по истечении таймаута
- **SIGUSR2**: Немедленный откат при критической ошибке

### Проверки
- Валидация конфигурации до изменений
- Проверка запуска service после переключения
- Проверка фактического режима (is_service_mode)

## 5. Тестирование и верификация

### Сценарии тестирования
1. Успешное переключение с подтверждением
2. Автоматический откат по таймауту
3. Немедленный откат при неудачном запуске service
4. Отказ пользователя от переключения
5. Обработка неверной конфигурации sshd

### Команды верификации
- `systemctl status ssh.socket` - проверка socket режима
- `systemctl status ssh.service` - проверка service режима
- `sshd -t` - валидация конфигурации
- `ssh -p <port> localhost` - проверка подключения

## 6. Резюме изменений

### Новые файлы
- `docs/plans/2025-01-23-ssh-socket-rollback-design.md` - дизайн документ
- `docs/test-cases/ssh-socket-rollback-test-cases.md` - тестовые сценарии

### Измененные файлы
- `lib/vars.conf` - добавлена переменная SSH_SOCKET_ROLLBACK_TIMER_SECONDS
- `modules/common-helpers.sh` - добавлена функция sys::validate_sshd_config
- `modules/03-ssh-socket-check.sh` - реализован механизм отката
- `modules/03-ssh-socket-helpers.sh` - добавлена функция ssh::switch_to_socket_mode
- `utils/rollback.sh` - поддержка нового типа отката ssh_socket
- `utils/test-ssh-modes.sh` - рефакторинг валидации конфигурации

### Новые функции
- `sys::validate_sshd_config` - валидация sshd конфигурации
- `ssh::switch_to_socket_mode` - переключение на socket режим
- `orchestrator::ssh_socket_rollback` - откат на socket режим
- `orchestrator::switch_to_service_with_guard` - оркестрация переключения с защитой
- `orchestrator::watchdog_start` - запуск watchdog
- `orchestrator::watchdog_stop` - остановка watchdog
- `orchestrator::guard_ui_instructions` - инструкции для пользователя
- `make_fifo_and_start_reader` - создание FIFO канала
- `stop_script_by_rollback_timer` - обработчик сигнала SIGUSR1
