# AGENTS.md - Руководство по работе с тестами i18n

## Обзор

Этот каталог содержит тесты для проверки целостности системы переводов (i18n) проекта BSSS.

### Структура каталога

```
lib/i18n/.tests/
├── helpers/
│   └── test_helpers.sh          # Общие хелперы для всех тестов
├── run.sh                      # Запуск всех тестов одновременно
├── test_missing_translations.sh # Проверка неизвестных ключей перевода
├── test_translations.sh         # Проверка синхронизации между языками
├── test_unused_translations.sh  # Проверка неиспользуемых ключей
└── test_hardcoded_strings.sh   # Проверка захардкоженных строк
```

## Как запустить тесты

### Порядок чтения результатов тестов (ВАЖНО)

**Сначала проверьте `test_unused_translations.sh`, потом `test_translations.sh`!**

Почему:
1. Если в тестах найдены неиспользуемые ключи — удалите их ПЕРЕД синхронизацией
2. Если сначала синхронизировать переводы, а потом узнать, что ключи не используются — придется дважды редактировать файлы
3. Пример: ключи `common.loaded` и `common.unknown_error` были синхронизированы, но не использовались в коде. Их пришлось удалить из всех языковых файлов.

Правильный порядок работы с результатами тестов:
```
1. test_unused_translations.sh → Удаляем неиспользуемые ключи из ВСЕХ языков
2. test_translations.sh → Синхронизируем ключи между языками
3. test_missing_translations.sh → Добавляем отсутствующие ключи
```

### Запуск всех тестов (Рекомендуется)

```bash
bash lib/i18n/.tests/run.sh
```

### Запуск отдельных тестов

```bash
# Проверка синхронизации переводов между языками
bash lib/i18n/.tests/test_translations.sh

# Проверка неизвестных/отсутствующих ключей
bash lib/i18n/.tests/test_missing_translations.sh

# Проверка неиспользуемых ключей
bash lib/i18n/.tests/test_unused_translations.sh

# Проверка захардкоженных строк
bash lib/i18n/.tests/test_hardcoded_strings.sh
```

## Интерпретация результатов тестов

### 1. test_translations.sh - Синхронизация переводов

**Что проверяет**: Все ключи перевода существуют во всех языковых файлах.

**Результаты**:
- **"All translations are synchronized"** - ✓ Все ключи присутствуют во всех языках
- **"Missing key [key] in language [lang]"** - ✗ Ключ отсутствует в указанном языке

**Действия при ошибках**:
1. Найдите отсутствующий ключ в файле другого языка (например, в `ru/common.sh`)
2. Добавьте тот же ключ в недостающий файл (`en/common.sh`)
3. Переведите значение на соответствующий язык

**Пример исправления**:
```
Ошибка: Missing key [common.menu_language] in language [en]

Решение:
1. Проверить ru/common.sh: I18N_MESSAGES["common.menu_language"]="%s. Язык..."
2. Добавить в en/common.sh: I18N_MESSAGES["common.menu_language"]="%s. Language..."
```

---

### 2. test_missing_translations.sh - Неизвестные ключи

**Что проверяет**: Все ключи перевода, используемые в коде, существуют в файлах переводов.

**Результаты**:
- **"All used translations exist"** - ✓ Все используемые ключи существуют
- **"Missing translation key [key] in translation files"** - ✗ Ключ используется в коде, но не найден в файлах переводов

**Действия при ошибках**:
1. Найдите где в коде используется этот ключ (`grep -r "key"`)
2. Определите правильный формат ключа (проверьте опечатки)
3. Добавьте ключ во все языковые файлы или исправьте опечатку в коде

**Важно**: Всегда добавляйте перевод СНАЧАЛА в русский файл (`lib/i18n/ru/`), затем переводчик добавит другие языки.

---

### 3. test_unused_translations.sh - Неиспользуемые ключи

**Что проверяет**: Ключи, которые существуют в файлах переводов, но не используются в коде.

**Результаты**:
- **"All translations are used"** - ✓ Все ключи используются
- **"Unused translation key [key] in language [lang]"** - ✗ Ключ определен, но не используется

**Действия при ошибках**:
1. Проверьте, действительно ли ключ не используется:
   ```bash
   grep -r '$(_ "key")' modules/ utils/ main.sh oneline-runner.sh
   ```
2. Если ключ действительно не используется - **удалите его** из ВСЕХ языковых файлов
3. Если ключ используется, но тест его не находит:
   - Проверьте, что используется синтаксис `$(_ "key")` с кавычками
   - Убедитесь, что ключ содержит точку (формат `module.submodule.action`) ИЛИ это специальный ключ `no_translate`

**Специальные ключи**:
- `no_translate` - используется для строк, которые не должны переводиться (пути, динамические строки)
- Этот ключ определен в `lib/i18n/critical/common.sh` и загружается до основной системы i18n

**⚠️ ВАЖНО**: Удаляйте неиспользуемые ключи! Они создают мусор в файлах переводов и усложняют поддержку.

---

### 4. test_hardcoded_strings.sh - Захардкоженные строки

**Что проверяет**: Поиск захардкоженных строк в вызовах printf/echo/print, которые могут требовать локализации.

**Результаты**:
- **"No hardcoded strings found that need translation"** - ✓ Нет строк, требующих локализации
- **"WARNING: Found N hardcoded string(s)"** - ⚠️ Найдены захардкоженные строки, которые могут требовать перевода

**⚠️ ВАЖНО**: Этот тест НЕ является определяющим. Конечный результат нужно просматривать вручную. Тест только подсвечивает места, где возможно захардкожены строки, но решение о необходимости перевода принимает пользователь.

**Действия при найденных строках**:
1. **Проверьте контекст**: Не все найденные строки требуют перевода
   - Строки для бизнес-процессов (внутренние операции) - НЕ нужно переводить
   - Строки для логов и пользовательского интерфейса - НУЖНО переводить

2. **Как определить, нужна ли локализация**:
   - **Требует перевода**: Сообщения для пользователя, логи, статусы, ошибки
     ```bash
     # ПЛОХО - захардкожено
     log_info "SSH port changed successfully"

     # ХОРОШО - с переводом
     log_info "$(_ "ssh.success_port_up")"
     ```
   - **Не требует перевода**: Внутренние операции, бизнес-процессы, вывод переменных
     ```bash
     # ХОРОШО - бизнес-процесс, не требует перевода
     printf '%s\n' "$port"
     printf '%s\0' "$key"
     ```

3. **Как исправить** (если нужна локализация):
   - Добавьте перевод в `lib/i18n/ru/соответствующий_файл.sh`:
     ```bash
     I18N_MESSAGES["ssh.success_port_up"]="SSH порт успешно изменен"
     ```
   - Замените захардкоженную строку на вызов функции перевода:
     ```bash
     # Было
     log_info "SSH port changed successfully"

     # Стало
     log_info "$(_ "ssh.success_port_up")"
     ```

**Ложные срабатывания**: Тест может найти строки, которые не требуют перевода:
- Внутренние операции (форматирование данных, проверка условий)
- Бизнес-процессы (вывод портов, ключей, путей)
- Строки с переменными (даже если переменная внутри кавычек)
- Маркеры и флаги ("EXIT", "CHECK", и т.д.)

---

## Архитектура тестов

### Как работают тесты

Все тесты используют общий набор хелперов из `helpers/test_helpers.sh`:

#### Основные функции хелперов

1. **`i18n::get_languages`** - Получает список языковых каталогов (`ru`, `en`, ...)
2. **`i18n::extract_keys`** - Извлекает все ключи из файлов переводов
3. **`i18n::extract_keys_from_code`** - Извлекает ключи из исходного кода проекта

#### i18n::extract_keys_from_code - Детали

Эта функция сканирует следующие директории:
```bash
"${PROJECT_ROOT}/modules/helpers"
"${PROJECT_ROOT}/modules"
"${PROJECT_ROOT}/utils"
"${PROJECT_ROOT}"
```

Извлекает ключи двух типов:

**1. Метазаголовки MODULE_NAME**:
```bash
# MODULE_NAME: module.ssh.name
```

**2. Вызовы функции _()**:
```bash
log_info "$(_ "ssh.success_port_up" "$port")"
```

**Правила валидации ключей**:
- Ключ должен содержать точку (`.`) для формата `module.submodule.action`
- ИЛИ ключ должен быть равен `no_translate` (специальный случай для критических мест)

**Почему это важно**: Это позволяет избежать ложных срабатываний для переменных или других строковых значений в коде.

---

## Процесс работы с тестами (для агентов-программистов)

### Когда запускать тесты

1. **ПЕРЕД созданием PR/коммитом** - Всегда запускайте `bash lib/i18n/.tests/run.sh`
2. **После добавления новых сообщений** - Убедитесь, что все новые ключи есть во всех языках
3. **После рефакторинга** - Проверьте, не остались ли неиспользуемые ключи
4. **После удаления кода** - Удалите соответствующие неиспользуемые ключи переводов

### Процесс добавления новых переводов

**Шаг 1**: Добавьте сообщение в `lib/i18n/ru/соответствующий_файл.sh`:
```bash
I18N_MESSAGES["module.submodule.action.message"]="Перевод на русском"
```

**Шаг 2**: Используйте в коде:
```bash
log_info "$(_ "module.submodule.action.message")"
```

**Шаг 3**: Запустите тесты:
```bash
bash lib/i18n/.tests/run.sh
```

**Шаг 4**: Если тесты показывают отсутствующие ключи в других языках - **это нормально**. Агент-переводчик добавит их позже.

### Процесс удаления кода с переводами

**Шаг 1**: Удалите код
**Шаг 2**: Запустите `test_unused_translations.sh`
**Шаг 3**: Удалите ВСЕ неиспользуемые ключи из ВСЕХ языковых файлов
**Шаг 4**: Запустите `run.sh` для проверки

**ВАЖНО**: Всегда сначала удаляйте неиспользуемые ключи, потом синхронизируйте. Это предотвратит лишнюю работу.

---

## Распространенные проблемы и решения

### Проблема: "Unused translation key [key]" но я использую этот ключ

**Возможные причины**:
1. Использование без кавычек:
   ```bash
   # ПЛОХО
   log_info "$(_ module.key)"
   # ХОРОШО
   log_info "$(_ "module.key")"
   ```

2. Использование переменной вместо ключа:
   ```bash
   # ПЛОХО - тесты не видят это
   local key="module.key"
   log_info "$(_ "$key")"
   ```

3. Ключ используется в файле, который исключен из поиска:
   - Проверьте `helpers/test_helpers.sh:100` список директорий поиска
   - Файл `oneline-runner.sh` исключен намеренно (он имеет свою систему переводов)

### Проблема: "Missing key [key] in translation files"

**Возможные причины**:
1. Опечатка в ключе:
   ```bash
   # Код использует
   log_info "$(_ "comon.error_message")"
   # Но в файле перевода
   I18N_MESSAGES["common.error_message"]="Ошибка"
   # Обратите внимание: comon vs common
   ```

2. Ключ добавлен только в один язык, но не в остальные

### Проблема: test_translations.sh не находит новый ключ

**Проверьте**:
1. Ключ добавлен в правильный файл домена (`common.sh`, `ssh.sh`, `ufw.sh`, `system.sh`)
2. Формат правильный: `I18N_MESSAGES["key"]="value"`
3. Нет синтаксических ошибок в файле

---

## Конвенции и best practices

### Нейминг ключей

**Формат**: `module.submodule.action.message_type`

**Примеры**:
- `common.error_root_privileges` - ошибка из общего модуля
- `ssh.success_port_up` - успех из SSH модуля
- `ufw.status.enabled` - статус из UFW модуля

**Типы сообщений**:
- `.error_` - сообщения об ошибках
- `.info_` - информационные сообщения
- `.success_` - сообщения об успехе
- `.warning_` - предупреждения
- `.hint_` - подсказки для ввода

### Где создавать переводы

**ru/ (русский)** - основной файл для агентов-программистов
**en/** - заполняется агентом-переводчиком
**critical/** - только для `no_translate` - не трогать

### Использование в коде

```bash
# Простое сообщение
log_info "$(_ "module.key")"

# С аргументами (printf форматирование)
log_info "$(_ "module.key" "$arg1" "$arg2")"

# Для путей и динамических строк
log_info "$(_ "no_translate" "/path/to/file")"
```

---

## Дополнительные сведения

### Почему тесты важны

1. **Консистентность**: Все языки имеют одинаковые ключи
2. **Чистота кода**: Удаляются неиспользуемые переводы
3. **Раннее обнаружение**: Ошибки найдены до того, как попадут в продакшн
4. **Поддерживаемость**: Легче добавлять новые языки

### Ложные срабатывания

Тесты могут давать ложные срабатывания в следующих случаях:

1. **Условное использование**: Ключ используется только в ветке `if`, которая редко выполняется
2. **Динамические ключи**: Ключ собирается из переменных во время выполнения
3. **Зарезервированные ключи**: Ключи на будущее (планируется использовать позже)

В таких случаях:
- Если ключ действительно нужен - прокомментируйте, почему он используется (добавьте TODO)
- Если ключ не нужен - удалите его

### Производительность тестов

- Время выполнения: < 2 секунды на типичной машине
- Используют только `find`, `grep`, `awk`, `sort` - стандартные Unix-утилиты
- Не требуют зависимостей

---

## Контакт и поддержка

Если возникают вопросы или проблемы с тестами:

1. Проверьте этот документ
2. Изучите код в `helpers/test_helpers.sh`
3. Посмотрите на примеры использования в `test_*.sh`

---

## История изменений

- **2025-02-07**: Создан файл AGENTS.md с руководством для агентов
- Добавлена документация по интерпретации результатов
- Добавлено описание архитектуры тестов
