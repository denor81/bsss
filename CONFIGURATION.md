# Конфигурация BSSS

## Обзор

Проект BSSS использует централизованную систему конфигурации для устранения хардкода и соблюдения принципа DRY (Don't Repeat Yourself). Все параметры настроек хранятся в едином конфигурационном файле.

## Структура конфигурационного файла

Основной конфигурационный файл находится в `config/bsss.conf` и разделен на логические секции:

### 1. Установщик и репозиторий
- Параметры GitHub репозитория
- Пути для установки и временные файлы
- URL для one-line установки

### 2. SSH конфигурация
- Пути к SSH конфигурационным файлам
- Параметры SSH по умолчанию
- Паттерны для файлов конфигурации SSH

### 3. Сетевые настройки
- Настройки брандмауэра
- Протоколы и политики

### 4. Системные настройки
- Параметры GRUB для отключения IPv6
- Имена системных сервисов

### 5. Конфигурация файлов
- Индексы для файлов конфигурации
- Расширения и префиксы

### 6. Системные сервисы
- Имена сервисов для управления
- Команды обновления

### 7. Сообщения и интерфейс
- Текстовые сообщения и метки
- Статусы и состояния
- Значения для подтверждений

### 8. Диапазоны и ограничения
- Диапазон допустимых портов
- Файлы для проверки системного состояния

## Механизм загрузки конфигурации

### Автоматическая загрузка

Конфигурация автоматически загружается через модуль `modules/helpers/config-loader.sh`:

```bash
# Подключение модуля загрузки конфигурации
source "${CACHE_BASE}/helpers/config-loader.sh"

# Автоматическая загрузка при первом обращении
load_config
```

### Получение параметров

Для получения параметров используется функция `get_config()`:

```bash
# Получение параметра с автоматической загрузкой конфигурации
SSH_PORT_DEFAULT="$(get_config SSH_PORT_DEFAULT)"
```

## Использование в модулях

### Стандартный шаблон для модулей

```bash
#!/usr/bin/env bash

# Загрузка конфигурации
source "${CACHE_BASE}/helpers/config-loader.sh"
load_config

# Получение конфигурационных параметров
PARAM_NAME="$(get_config CONFIG_PARAM_NAME)"

# Использование параметра
echo "Значение: $PARAM_NAME"
```

### Пример замены хардкода

**До:**
```bash
SSH_CONFIG_DIR="/etc/ssh/sshd_config.d"
SSH_PORT_DEFAULT="22"
```

**После:**
```bash
SSH_CONFIG_DIR="$(get_config SSH_CONFIG_DIR)"
SSH_PORT_DEFAULT="$(get_config SSH_PORT_DEFAULT)"
```

## Преимущества централизованной конфигурации

1. **Устранение дублирования:** Все параметры определены в одном месте
2. **Легкость поддержки:** Изменение параметра требует правки только одного файла
3. **Гибкость:** Легко адаптировать под разные окружения
4. **Читаемость:** Ясная структура с разделением на логические секции
5. **Безопасность:** Централизованное управление чувствительными параметрами

## Добавление новых параметров

1. Определите логическую секцию для нового параметра
2. Добавьте параметр в `config/bsss.conf`
3. Используйте `get_config()` в коде для получения значения

Пример:
```bash
# В config/bsss.conf
NEW_PARAM="default_value"

# В коде
NEW_PARAM_VALUE="$(get_config NEW_PARAM)"
```

## Миграция со старой версии

Старые модули с хардкодом автоматически обновляются для использования новой системы конфигурации. Процесс миграции:

1. Добавление загрузчика конфигурации
2. Замена хардкод значений на вызовы `get_config()`
3. Тестирование функциональности

## Валидация конфигурации

Модуль `config-loader.sh` автоматически проверяет:
- Наличие конфигурационного файла
- Существование запрашиваемых параметров
- Корректность загрузки конфигурации

При ошибках выводятся информативные сообщения и выполнение прерывается.